/*!
 * Factlink client library v0.0.5
 * http://factlink.com/
 *
 * Copyright 2011, Factlink
 * 
 * Date: Wed May 11 14:27:29 2011 +0200
 */
(function(a,b){var c=a.document,d=a.setTimeout,e=a.alert,f=a.Ender||a.jQuery,g=a.Factlink=function(){var e={results:[]};e.getTheFacts=function(){var b=a.location,c=e.conf.api.loc+"/site?url="+b.protocol+"//"+b.hostname+b.pathname;e.util.addStyleSheet(e.conf.css.loc),f.ajax({url:c,dataType:"jsonp",crossDomain:!0,type:"GET",jsonp:"callback"}).success(function(a){for(var b=0;b<a.length;b++)e.selectRanges(e.search(a[b].displaystring),a[b]._id)})},e.destroy=function(){try{e.overlay.hide(),e.iframe.remove()}catch(b){}a.Factlink=null},e.util={},e.util.hasInnerText=c.getElementsByTagName("body")[0].innerText!==b?!0:!1,e.util.addStyleSheet=function(a){typeof this.added_stylesheets!="object"&&(this.added_stylesheets=[]);if(this.added_stylesheets.indexOf(a)===-1){this.added_stylesheets[a]=1;var b=c.createElement("link");b.type="text/css",b.rel="stylesheet",b.href=a,c.getElementsByTagName("head")[0].appendChild(b)}},e.util.walkTheDOM=function g(a,b){if(b(a)===!1)return!1;a=a.firstChild;while(a)if(g(a,b)!==!1)a=a.nextSibling;else return!1},e.util.debug=function(){a.console&&a.console.info&&a.console.info.apply(a.console,arguments)},e.util.domReady=function(a){/in/.test(c.readyState)?d(function(){e.util.domReady(a)},50):a()};return e}();g.conf={api:{loc:"http://development.factlink.com"},lib:{loc:"http://static.factlink.com/lib"}},g.conf.css={loc:g.conf.lib.loc+"/src/css/basic.css?"+(new Date).getTime()},g.submitFact=function(){var c=a.getSelection();a.rangy!==b&&(c=a.rangy.getSelection());try{var d=c.getRangeAt(0)}catch(h){e("bam");return!1}if(d.toString().length<1)return!1;f.ajax({url:g.conf.api.loc+"/factlink/new",dataType:"jsonp",crossDomain:!0,jsonp:"callback",type:"post",data:{url:a.location.href,fact:d.toString()}}).success(function(a){a.status===!0?g.selectRanges([d]):e("Something went wrong")}).error(function(a){})};var h=null,i=null,j=10,k=function(){if(a.getSelection)var b=a.getSelection();else if(c.getSelection)var b=c.getSelection();else{if(!c.selection)return"";var b=c.selection.createRange().text}return b};f("body").bind("mouseup",function(a){h=k(),i=h.toString(),i!==null&&i.length>j&&h.rangeCount>0&&(g.timeout=d(function(){g.startSubmitting(h.getRangeAt(0),a.pageY,a.pageX)},500))}),g.startSubmitting=function(b,c,d){g.remote.prepareNewFactlink(b.toString(),"NotImplemented",a.location.href),g.modal.positionFrame.method(c,d),g.modal.showFrame.method()};var l=g.Loader={el:f('<div class="loader"><h1>Factlink</h1><p id="fl-status">Loading Factlink sources</p><ul class="fl-status-list"></ul></div>')};l.init=function(){this.el.hide().appendTo("body")},l.open=function(){this.el.show()},l.updateStatus=function(a){var b=this.el.find(".fl-status-list");b.append('<li class="hide">'+a+"</li>"),b.find(":not(.hide)").fadeOut("fast",function(){f(this).addClass("hide").next("li").fadeIn("fast",function(){f(this).removeClass("hide")})})},l.finish=function(){this.el.fadeOut()},g.initProxy=function(){g.utils.domReady(function(){var b=c.getElementsByTagName("a");for(var d=0,e=b.length;d<e;d++){var f=b[d],g=f.href,h=!1;g.length>0&&(g.search(/http:\/\//)!==0?g.search(/mailto:/)!==0&&g.search(/javascript:/)!==0&&a.console.info("N: "+g):h=!0),h&&(f.href=g.replace(/^http:\/\//,"http://fct.li:8080/s/http://"))}})},g.selectRanges=function(a,b){var c,d;for(c=a.length;c--;){var e=a[c],f=e.startContainer,g=e.endContainer,h=c,i=[],j;while(--h>0&&a[h].startContainer===f)i.push({startOffset:a[h].startOffset,endOffset:a[h].endOffset}),--c;this.replaceFactNodes(e.startOffset,e.endOffset,f,g,e.commonAncestorContainer);if(i.length>0)for(d=0;d<i.length;d++)j=i[d],this.replaceFactNodes(j.startOffset,j.endOffset,f,g,e.commonAncestorContainer)}for(c=0;c<this.results.length;c++){var k=this.results[c];m(k.startOffset,k.endOffset,k.node,b)}};var m=function(a,b,d,e){var f=d.nodeValue.split(""),g=f.splice(a,f.length);if(b<d.nodeValue.length&&b!==0){var h=g.splice(b-a,g.length).join("");g.length=b-a,d.parentNode.insertBefore(c.createTextNode(h),d.nextSibling)}var i=o(g.join(""),e);d.nodeValue=f.join(""),d.parentNode.insertBefore(i,d.nextSibling)},n=[],o=function(a,b){var d=c.createElement("span");d.className="factlink",d.setAttribute("data-factid",b),n.push(b),g.util.hasInnerText?d.innerText=a:d.textContent=a;return d};g.replaceFactNodes=function(a,c,d,e,f){var h=!1,i=this;g.util.walkTheDOM(f,function(f){if(f!==b&&f.nodeType===3){var g=0;f===d&&(h=!0,g=a);if(h){var j=f.nodeValue.length;f===e&&(j=c),i.results.push({startOffset:g,endOffset:j,node:f})}if(h&&f===e)return!1}})},a.ids=n,g.search=function(b){var c=a.document,d=a.alert,e=[],f=c.body.scrollTop,g=c.body.scrollLeft,h=a.rangy,i,j,k,l;if(a.find){a.getSelection().removeAllRanges();while(a.find(b,!1))i=a.getSelection(),j=i.getRangeAt(0),e.push(j);a.getSelection().removeAllRanges()}else if(c.body.createTextRange){j=c.body.createTextRange();if(j.findText){c.documentMode&&c.documentMode===8&&d("Your browser is currently running in IE8 Mode, this rendering mode of IE8 has a bug which may cause Factlink from not finding all the available Factlinks on this page.");while(j.findText(b))try{j.select(),i=h.getSelection(),k=i.getRangeAt(0),e.push(k),j.collapse(!1),i.removeAllRanges()}catch(m){j.collapse(!1)}}else d("Your browser does not support the proper find functionality")}else d("Unimplemented");a.scroll(g,f);return e},g.showInfo=function(a){g.remote.showFactlink(a.getAttribute("data-factid")),g.modal.showFrame.method(),g.modal.showOverlay.method()},f("span.factlink").live("click",function(){g.showInfo(this)}),g.modal={positionFrame:function(a,b){g.$frame.css({top:a,left:b})},resetStyle:function(){g.$frame.attr("style","")},setFrameBounds:function(a,b){var c=g.$frame;c.css({height:b,width:a}),c.hasClass("show")&&c.css({margin:"-"+b/2+"px 0 0 -"+a/2+"px"})},hideFrame:function(){q(),g.$frame.hide()},showFrame:function(){p(),g.$frame.show()},setFrameType:function(a){g.$frame.attr("class",a).show()},showOverlay:function(){g.overlay.show()},hideOverlay:function(){g.overlay.hide()},highlightNewFactlink:function(a,b){g.selectRanges(g.search(a),b)}};var p=function(){f(c).bind("click",r)},q=function(){f(c).unbind("click",r)},r=function(){g.modal.hideOverlay.method(),g.modal.hideFrame.method()};g.$frame=f("<div />").attr({id:"factlink-modal-frame"}).appendTo("body"),g.remote=new easyXDM.Rpc({swf:g.conf.api.loc+"/client/easyXDM/src/easyxdm.swf",remote:g.conf.api.loc+"/factlink/intermediate",container:"factlink-modal-frame"},{local:g.modal,remote:{prepareNewFactlink:{},showFactlink:{}}}),g.util!==b?(g.getTheFacts(),g.overlay=f('<div id="factlink-overlay" />').appendTo("body")):d(function(){arguments.callee(g)},10),a.Factlink=g})(window)