/*!
 * Factlink client library v0.0.1
 * http://factlink.com/
 *
 * Copyright 2011, Factlink
 * 
 * Date: Thu Apr 21 11:36:50 2011 +0200
 */
(function(a,b){var c=a.document,d=a.setTimeout,e=a.alert,f=a.Ender||a.jQuery,g=function(){var e={results:[]};e.getTheFacts=function(){var b=a.location,c=e.CONF.API.loc+"/site?url="+b.protocol+"//"+b.hostname+b.pathname,d=this;console.info(c),f.ajax({url:c,dataType:"jsonp",crossDomain:!0,type:"GET",jsonp:"callback"}).success(function(a){for(var b=0;b<a.length;b++)d.selectRanges(d.search(a[b].displaystring))})},e.util={},e.util.hasInnerText=c.getElementsByTagName("body")[0].innerText!==b?!0:!1,e.util.addStyleSheet=function(a){var b=c.createElement("link");b.type="text/css",b.rel="stylesheet",b.href=a,c.getElementsByTagName("head")[0].appendChild(b)},e.util.walkTheDOM=function g(a,b){if(b(a)===!1)return!1;a=a.firstChild;while(a)if(g(a,b)!==!1)a=a.nextSibling;else return!1},e.util.debug=function(){a.console&&a.console.info&&a.console.info.apply(a.console,arguments)},e.util.domReady=function(a){/in/.test(c.readyState)?d(function(){e.util.domReady(a)},50):a()};return e}();g.CONF={API:{loc:"http://tom:1337"}},g.submitFact=function(){var c=this,d=a.getSelection();a.rangy!==b&&(d=a.rangy.getSelection());try{var g=d.getRangeAt(0)}catch(h){e("bam");return!1}if(g.toString().length<1)return!1;f.ajax({url:"http://tom:1337/factlink/new",dataType:"jsonp",crossDomain:!0,jsonp:"callback",type:"post",data:{url:a.location.href,fact:g.toString()}}).success(function(b){b.status===!0?c.selectRanges([g]):(a.console.info(b),e("Something went wrong"))}).error(function(a){})};var h=g.Loader={el:f('<div class="loader"><h1>Factlink</h1><p id="fl-status">Loading Factlink sources</p><ul class="fl-status-list"></ul></div>')};h.init=function(){this.el.hide().appendTo("body")},h.open=function(){this.el.show()},h.updateStatus=function(a){var b=this.el.find(".fl-status-list");b.append('<li class="hide">'+a+"</li>"),b.find(":not(.hide)").fadeOut("fast",function(){f(this).addClass("hide").next("li").fadeIn("fast",function(){f(this).removeClass("hide")})})},h.finish=function(){this.el.fadeOut()},g.initProxy=function(){g.utils.domReady(function(){var b=c.getElementsByTagName("a");for(var d=0,e=b.length;d<e;d++){var f=b[d],g=f.href,h=!1;g.length>0&&(g.search(/http:\/\//)!==0?g.search(/mailto:/)!==0&&g.search(/javascript:/)!==0&&a.console.info("N: "+g):h=!0),h&&(f.href=g.replace(/^http:\/\//,"http://fct.li:8080/s/http://"))}})},g.selectRanges=function(a){var b,c;for(b=a.length;b--;){var d=a[b],e=d.startContainer,f=d.endContainer,g=b,h=[],j;while(--g>0&&a[g].startContainer===e)h.push({startOffset:a[g].startOffset,endOffset:a[g].endOffset}),--b;this.replaceFactNodes(d.startOffset,d.endOffset,e,f,d.commonAncestorContainer);if(h.length>0)for(c=0;c<h.length;c++)j=h[c],this.replaceFactNodes(j.startOffset,j.endOffset,e,f,d.commonAncestorContainer)}for(b=0;b<this.results.length;b++){var k=this.results[b];i(k.startOffset,k.endOffset,k.node)}};var i=function(a,b,d){var e=d.nodeValue.split(""),f=e.splice(a,e.length);if(b<d.nodeValue.length&&b!==0){var g=f.splice(b-a,f.length).join("");f.length=b-a,d.parentNode.insertBefore(c.createTextNode(g),d.nextSibling)}var h=j(f.join(""));d.nodeValue=e.join(""),d.parentNode.insertBefore(h,d.nextSibling)},j=function(a,b){var d=c.createElement("span");d.className="factlink",d.setAttribute("data-factid",b),g.util.hasInnerText?d.innerText=a:d.textContent=a;return d};g.replaceFactNodes=function(a,c,d,e,f){var h=!1,i=this;g.util.walkTheDOM(f,function(f){if(f!==b&&f.nodeType===3){var g=0;f===d&&(h=!0,g=a);if(h){var j=f.nodeValue.length;f===e&&(j=c),i.results.push({startOffset:g,endOffset:j,node:f})}if(h&&f===e)return!1}})},g.search=function(a){var b=b,c=b.document,d=b.alert,e=[],f=c.body.scrollTop,g=c.body.scrollLeft,h=b.rangy,i,j,k,l;if(b.find){b.getSelection().removeAllRanges();while(b.find(a,!1))i=b.getSelection(),j=i.getRangeAt(0),e.push(j);b.getSelection().removeAllRanges()}else if(c.body.createTextRange){j=c.body.createTextRange();if(j.findText){c.documentMode&&c.documentMode===8&&d("Your browser is currently running in IE8 Mode, this rendering mode of IE8 has a bug which may cause Factlink from not finding all the available Factlinks on this page.");while(j.findText(a))try{j.select(),i=h.getSelection(),k=i.getRangeAt(0),e.push(k),j.collapse(!1),i.removeAllRanges()}catch(m){j.collapse(!1)}}else d("Your browser does not support the proper find functionality")}else d("Unimplemented");l(g,f);return e},a.Factlink=g})(window)