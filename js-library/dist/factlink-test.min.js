/*!
 * Factlink client library v0.0.1
 * http://factlink.com/
 *
 * Copyright 2011, Factlink
 * 
 * Date: @DATE
 */
(function(a,b){var c=a.document,d=function(){var d=function(){this.results=[],d.util.addStyleSheet("http://factlink:8000/src/styles/factlink.css?"+(new Date).getTime())};d.prototype.getTheFacts=function(){var b=a.location,c="http://tom:1337/factlinks_for_url.json?url="+b.protocol+"//"+b.hostname+b.pathname,d=this;FL.Loader.updateStatus("Retrieving the facts from the server"),$.ajax({url:c,dataType:"jsonp",crossDomain:!0,type:"GET",jsonp:"callback"}).success(function(a){for(var b=0;b<a.length;b++)FL.Loader.updateStatus('Finding matches for fact: "'+a[b].displaystring+'"'),d.selectRanges(d.search(a[b].displaystring));FL.Loader.finish()})},d.util={},d.util.hasInnerText=c.getElementsByTagName("body")[0].innerText!=b?!0:!1,d.util.addStyleSheet=function(a){var b=c.createElement("link");b.type="text/css",b.rel="stylesheet",b.href=a,c.getElementsByTagName("head")[0].appendChild(b)},d.util.walkTheDOM=function e(a,b){if(b(a)===!1)return!1;a=a.firstChild;while(a)if(e(a,b)!==!1)a=a.nextSibling;else return!1},d.util.debug=function(){a.console&&a.console.info&&a.console.info.apply(console,arguments)},d.util.domReady=function(a){/in/.test(c.readyState)?setTimeout(function(){domReady(a)},50):a()};return d}();d.prototype.submitFact=function(){var c=this;if(a.rangy===b)var d=a.getSelection();else var d=a.rangy.getSelection();try{var e=d.getRangeAt(0)}catch(f){alert("bam");return!1}if(e.toString().length<1){FL.Loader.finish();return!1}$.ajax({url:"http://tom:1337/factlink/new",dataType:"jsonp",crossDomain:!0,jsonp:"callback",type:"post",data:{url:location.href,fact:e.toString()}}).success(function(a){a.status==!0?(c.selectRanges([e]),FL.Loader.finish()):(console.info(a),alert("Something went wrong"),FL.Loader.finish())}).error(function(a){FL.Loader.finish()})};var e=d.prototype.Loader={el:$('<div class="loader"><h1>Factlink</h1><p id="fl-status">Loading Factlink sources</p><ul class="fl-status-list"></ul></div>')};e.init=function(){this.el.hide().appendTo("body")},e.open=function(){this.el.show()},e.updateStatus=function(a){var b=this.el.find(".fl-status-list");b.append('<li class="hide">'+a+"</li>"),b.find(":not(.hide)").fadeOut("fast",function(){$(this).addClass("hide").next("li").fadeIn("fast",function(){$(this).removeClass("hide")})})},e.finish=function(){this.el.fadeOut()},d.prototype.initProxy=function(){d.utils.domReady(function(){var a=c.getElementsByTagName("a");for(var b=0,d=a.length;b<d;b++){var e=a[b],f=e.href,g=!1;f.length>0&&(f.search(/http:\/\//)!==0?f.search(/mailto:/)!==0&&f.search(/javascript:/)!==0&&console.info("N: "+f):g=!0),g&&(e.href=f.replace(/^http:\/\//,"http://fct.li:8080/s/http://"))}})},d.prototype.selectRanges=function(a){for(var b=a.length;b--;){var c=a[b],d=c.startContainer,e=c.endContainer,g=b,h=[];while(--g>0&&a[g].startContainer===d)h.push({startOffset:a[g].startOffset,endOffset:a[g].endOffset}),--b;this.replaceFactNodes(c.startOffset,c.endOffset,d,e,c.commonAncestorContainer);if(h.length>0)for(var i=0;i<h.length;i++){var j=h[i];this.replaceFactNodes(j.startOffset,j.endOffset,d,e,c.commonAncestorContainer)}}for(var b=0;b<this.results.length;b++){var k=this.results[b];f(k.startOffset,k.endOffset,k.node)}};var f=function(a,b,d){var e=d.nodeValue.split(""),f=e.splice(a,e.length);if(b<d.nodeValue.length&&b!==0){var h=f.splice(b-a,f.length).join("");f.length=b-a,d.parentNode.insertBefore(c.createTextNode(h),d.nextSibling)}var i=g(f.join(""));d.nodeValue=e.join(""),d.parentNode.insertBefore(i,d.nextSibling)},g=function(a,b){var e=c.createElement("span");e.className="factlink",e.setAttribute("data-factid",b),d.util.hasInnerText?e.innerText=a:e.textContent=a;return e};d.prototype.replaceFactNodes=function(a,c,e,f,g){var h=!1,i=this;d.util.walkTheDOM(g,function(d){if(d!==b&&d.nodeType===3){if(d===e){h=!0;var g=a}else if(h)var g=0;if(h){if(d===f)var j=c;else var j=d.nodeValue.length;i.results.push({startOffset:g,endOffset:j,node:d})}if(h&&d===f)return!1}})},d.prototype.search=function(b){var d=[],e=c.body.scrollTop,f=c.body.scrollLeft;if(a.find){a.getSelection().removeAllRanges();while(a.find(b,!1)){var g=a.getSelection(),h=g.getRangeAt(0);d.push(h)}a.getSelection().removeAllRanges()}else if(c.body.createTextRange){var h=c.body.createTextRange();if(h.findText){c.documentMode&&c.documentMode===8&&alert("Your browser is currently running in IE8 Mode, this rendering mode of IE8 has a bug which may cause Factlink from not finding all the available Factlinks on this page.");while(h.findText(b))try{h.select();var g=rangy.getSelection(),i=g.getRangeAt(0);d.push(i),h.collapse(!1),g.removeAllRanges()}catch(j){h.collapse(!1)}}else alert("Your browser does not support the proper find functionality")}else alert("Unimplemented");scroll(f,e);return d},a.Factlink=d})(window)