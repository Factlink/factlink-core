#!/bin/bash
echo 'Setting up core...'
cd "$( dirname "${BASH_SOURCE[0]}" )"/..

md5sum --check Gemfile.lock.md5cache || (
  bundle
  md5sum Gemfile.lock > Gemfile.lock.md5cache
)

exec 6<>/dev/tcp/127.0.0.1/9200 && ERROR_STATUS="" || ERROR_STATUS="closed"; exec 6>&-; exec 6<&-

if [[ -n "$ERROR_STATUS" ]]; then
  ../start-db.sh &
  FOREMAN_PID=$!
  sleep 3
fi

bundle exec rake db:migrate
bundle exec rake db:init

if [[ -n "$FOREMAN_PID" ]]; then
  kill $FOREMAN_PID
  wait
fi
