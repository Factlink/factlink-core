<!DOCTYPE html>
<html>
<head>
  <title>Intermediate action</title>

  <%= javascript_include_tag "intermediate" %>

  <%= javascript_include_tag "#{FactlinkUI::Application.config.static_url}/lib/dist/easyXDM/easyXDM.min.js" %>
  <style type="text/css">
    html, body {
      height: 100%;
      width: 100%;
      margin: 0 auto;
      padding: 0;
      overflow: hidden;
    }

    iframe {
      height: 100%;
      width: 100%;
      border: 0;
      z-index: 2147483646;
    }

    iframe.overlay {
      background: transparent;
    }

    form {
      display: none;
    }
  </style>

  <%= csrf_meta_tag %>
</head>
<body>
  <iframe src="" name="frame" id="frame"></iframe>

  <script type="text/javascript">
    var // The iFrame
        showFrame = document.getElementById("frame"),
        // The global remote object
        remote = new easyXDM.Rpc({}, {
          remote: {
            hide: {},
            show: {},
            highlightNewFactlink: {},
            stopHighlightingFactlink: {}
          },
          local: {
            showFactlink: function(id, successFn) {
              showFrame.onload = function() {
                showFrame.onload = undefined;
                successFn();
              };

              // Set the source of the iframe
              showFrame.src = "/facts/" + id;
              // Show the overlay
              showFrame.className = "overlay";
            },
            position: function(top, left) {
              try {
                showFrame.contentWindow.position(top, left);
              } catch (e) { // Window not yet loaded
                showFrame.onload = function() {
                  showFrame.contentWindow.position(top, left);
                };
              }
            },
            //easyXDM does not support passing functions wrapped in objects (such as options in this case)
            // so therefore we need this workaround
            ajax: function(path, options, successFn, errorFn) {
              ajax(path, $.extend({
                success: successFn,
                error: errorFn
              },options));
            }
          }
        });

    function ajax(path, options) {
      $.ajax(path, $.extend({
        headers: {
          'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
        }
      }, options));
    }
  </script>
</body>
</html>
