<% if user_signed_in? %>
  <%= form_tag facts_path(layout: @layout), class: "fact-block", id:"new_fact_form" do %>
    <div class="fact-view">
      <%= text_area_tag :fact, params[:fact] %>
      <%= hidden_field_tag :url, params[:url] %>
      <%= hidden_field_tag :title, params[:title] %>
      <% if @layout %>
        <%= hidden_field_tag :layout, value: @layout %>
      <% end %>

      <div class="fact-wheel"></div>

      <div class="fact-body">
        <%= params[:fact] %>
      </div>
    </div>

    <div id="add-to-container">
      <strong><%= t('.add_to_channels').capitalize %>:</strong>
      <div id="add-to-channels"></div>

      <div id="suggested-channels-region"></div>
    </div>

    <div class="buttons">
      <button class="btn" name="cancel" id="cancel">Cancel</button>
      <%= submit_tag "Post to Factlink",
                     class: "btn btn-primary",
                     "data-disable-with" => "Posting...",
                     id: "submit" %>
    </div>
  <% end %>
<% end %>

<% content_for :javascript do %>
  <script>
    <%= render 'backbone/currentUser' %>

    var addToCollection = new OwnChannelCollection();
    var addToChannelView = new AutoCompleteChannelsView({collection: addToCollection}).render();
    var suggestionView = new FilteredSuggestedSiteTopicsView({addToCollection: addToCollection, site_id: <%= @site ? @site.id : 'undefined' %> }).render();

    addToChannelView.on('error', function() {
      alert('Something went wrong when creating a new channel, sorry!');
    });

    $('#add-to-channels').html(addToChannelView.el);
    $('#suggested-channels-region').html(suggestionView.el);

    var persistentWheel = new PersistentWheelView({
      el: $('.fact-wheel'),
      model: new Wheel()
    }).render();

    persistentWheel.on('opinionSet', function () {
      parent.remote.trigger('opinionSet');
    });

    $('#cancel').on('click', function (e) {
      mp_track("Modal: Cancel");
      e.preventDefault();
      parent.remote.hide();
    });

    createWhatsYourOpinionTooltip();

    function createWhatsYourOpinionTooltip() {
      $('.fact-wheel').on('click', function () {
        hideTooltip();
      });

      $(window).on('resize', function () {
        destroyTooltip();
        showTooltip();
      });

      var _shouldShowTooltip = true;

      function showTooltip() {
        if ( ! _shouldShowTooltip ) return;

        $('.fact-wheel').tooltip({
          title: "What's your opinion?",
          trigger: "manual"
        }).tooltip('show');
      }

      function destroyTooltip() {
        $('.fact-wheel').tooltip('destroy');
      }

      function hideTooltip() {
        _shouldShowTooltip = false;

        destroyTooltip();
      }
    }

  </script>
<% end %>
