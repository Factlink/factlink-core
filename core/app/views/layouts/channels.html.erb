<% content_for :header do %>
<% end %>

<% content_for :left_column do %>
  <%= render "users/user_li", user: @user %>
  <%= render "channels/channels", user: @user %>
<% end %>

<% content_for :right_column do %>
  <div class="related-users">
    <%= render("channels/related_users",
                 :related_users => @channel.related_users(:without=>[current_graph_user]).andand.map{|x| x.user },
                 :excluded_users => [@channel.andand.created_by.andand.user])
               %>
  </div>
  
  <% if @channel and not @channel.new? %>
    <div id="activity-listing">
      <%= render "channels/activity_list", channel: @channel %>
    </div>
  <% end %>
<% end %>

<% content_for :javascript do %>

  <%= javascript_include_tag "backbone/models/channel.js" %>
  <%= javascript_include_tag "backbone/models/subchannel.js" %>
  <%= javascript_include_tag "backbone/collections/channels.js" %>
  <%= javascript_include_tag "backbone/collections/subchannels.js" %>
  <%= javascript_include_tag "backbone/collections/facts.js" %>
  <%= javascript_include_tag "backbone/views/subchannels_view.js" %>
  <%= javascript_include_tag "backbone/views/channel_item_view.js" %>
  <%= javascript_include_tag "backbone/views/subchannel_item_view.js" %>
  <%= javascript_include_tag "backbone/views/related_users_view.js" %>
  <%= javascript_include_tag "backbone/views/activities_view.js" %>
  <%= javascript_include_tag "backbone/views/channel_collection_view.js" %>
  <%= javascript_include_tag "backbone/views/channel_view.js" %>
  <%= javascript_include_tag "backbone/views/channel_app_view.js" %>
  <%= javascript_include_tag "backbone/router.js" %>

  <script>
    var Router = new Workspace();

    Backbone.history.start({pushState:true, silent:true});

    Channels.reset(<%= @user.graph_user.channels.map{|ch| Channels::SingleMenuItem.for_channel_and_view(ch,self,@user) }.to_json.html_safe %>);
    
    window.currentUser = new User(<%= current_user.to_json.html_safe %>);
    
    window.currentUser.setChannels(new OwnChannelList(<%= current_user.graph_user.channels.to_json.html_safe %>));
  </script>

  <script>
    $('.follow-channel').bind('click', function() {
      $.ajax({
        url: $(this).data('follow-url'),
        dataType: "script",
        success: function() {
          console.log("Succes");
        }
      });

      return false;
    });
  </script>
<% end %>

<% content_for :template do %>
  <script type="text/html" id="channel_li">
    <%= template_as_string "channels/_single_menu_item.html.mustache" %>
  </script>
  
  <script type="text/html" id="channel_overview">
    <%= template_as_string "channels/_channel.html.mustache" %>
  </script>
  
  <script type="text/html" id="subchannel_li">
    <%= template_as_string "subchannels/_subchannel_item.html.mustache" %>
  </script>
<% end %>

<%= render :template => 'layouts/frontend' %>
