<% content_for :header do %>
<% end %>

<% content_for :left_column do %>
  <%= render "channels/channels", user: @user %>
<% end %>

<% content_for :right_column do %>
  <div class="related-users">
    <%= render("channels/related_users",
                 :related_users => @channel.related_users(:without=>[current_graph_user]).andand.map{|x| x.user },
                 :excluded_users => [@channel.andand.created_by.andand.user])
               %>
  </div>
  
  <% if @channel and not @channel.new? %>
    <div id="activity-listing">
      <%= render "channels/activity_list", channel: @channel %>
    </div>
  <% end %>
<% end %>

<% content_for :javascript do %>

  <%= javascript_include_tag "backbone/contrib.js" %>
  <%= javascript_include_tag "backbone/models/channel.js" %>
  <%= javascript_include_tag "backbone/models/user.js" %>
  <%= javascript_include_tag "backbone/models/fact.js" %>
  <%= javascript_include_tag "backbone/models/subchannel.js" %>
  <%= javascript_include_tag "backbone/collections/channels.js" %>
  <%= javascript_include_tag "backbone/collections/own_channel_collection.js" %>
  <%= javascript_include_tag "backbone/collections/subchannels.js" %>
  <%= javascript_include_tag "backbone/collections/facts.js" %>
  <%= javascript_include_tag "backbone/views/subchannels_view.js" %>
  <%= javascript_include_tag "backbone/views/channel_item_view.js" %>
  <%= javascript_include_tag "backbone/views/subchannel_item_view.js" %>
  <%= javascript_include_tag "backbone/views/related_users_view.js" %>
  <%= javascript_include_tag "backbone/views/activities_view.js" %>
  <%= javascript_include_tag "backbone/views/own_channel_item_view.js" %>
  <%= javascript_include_tag "backbone/views/add_to_channel_view.js" %>
  <%= javascript_include_tag "backbone/views/channel_collection_view.js" %>
  <%= javascript_include_tag "backbone/views/facts_view.js" %>
  <%= javascript_include_tag "backbone/views/fact_view.js" %>
  <%= javascript_include_tag "backbone/views/channel_view.js" %>
  <%= javascript_include_tag "backbone/views/user_view.js" %>
  <%= javascript_include_tag "backbone/views/channel_app_view.js" %>
  <%= javascript_include_tag "backbone/router.js" %>

  <script>
    Channels.reset(<%= @user.graph_user.channels.map{|ch| Channels::SingleMenuItem.for_channel_and_view(ch,self,@user) }.to_json.html_safe %>);
    
    <% if @channel && !@channel.new? %>
      window.currentChannel = Channels.get(<%= @channel.id %>);
    <% end %>

    <% if current_user %>
      window.currentUser = new User(<%= Users::User.for_user(current_user, self).to_json.html_safe %>);

      window.currentUser.setChannels(new OwnChannelCollection(<%= current_graph_user.channels.map{|ch| Channels::SingleMenuItem.for_channel_and_view(ch,self) }.to_json.html_safe %>));
    <% end %>
    
    var Router = new Workspace();
    
    Backbone.history.start({pushState:true, silent:true});
    
  </script>
<% end %>

<% content_for :template do %>
  <%= load_js_template "user_block_tmpl",         "users/_user.html.mustache" %>
  <%= load_js_template "channel_li",              "channels/_single_menu_item.html.mustache" %>
  <%= load_js_template "channel_overview",        "channels/_channel.html.mustache" %>
  <%= load_js_template "subchannel_li",           "subchannels/_subchannel_item.html.mustache" %>
  <%= load_js_template "own_channels_collection", "channels/_own_channel_listing.html.mustache" %>
  <%= load_js_template "own_channel_li",          "channels/_own_channel.html.mustache" %>
  <%= load_js_template "fact_tmpl",               "facts/_fact.html.mustache" %>
  <%= load_js_template "fact_bubble_tmpl",        "facts/_fact_bubble.html.mustache" %>
  <%= load_js_template "fact_wheel_tmpl",         "facts/_fact_wheel.html.mustache" %>
  <%= load_js_template "facts_tmpl",              "channels/_facts.html.mustache" %>
<% end %>

<%= render :template => 'layouts/frontend' %>
