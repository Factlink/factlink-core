<% content_for :stylesheets do %>
  <%= stylesheet_link_tag "tour" %>
<% end %>

<div id="almost-done-wrapper">
  <h1>You're almost set!</h1>

  <div class="hidden chrome">
    <p>To use Factlink on all of your websites you should install our Chrome Extension.</p>
  </div>

  <div class="hidden no-chrome">
    <p>This browser is not fully supported. We've build a Chrome Extension that adds a layer to the web. To use this Extension you need to install Google Chrome.</p>

    <a id="chrome-download-button" class="btn download-chrome" href="https://google.com/chrome" target="_blank"><%= image_tag("chromeDarkIcon.png", style: "margin: -4px 8px 0 0") %>Install Google Chrome</a>
  </div>

  <div class="hidden no-chrome or-divider">
    <span>or</span>
  </div>

  <!-- Chrome Yeah! -->
  <div class="hidden button-wrapper chrome">
    <span class="transparent-border">

      <% if Rails.env == "production" %>
      <a id="chrome-extension-webstore-button" class="btn"><%= image_tag("chromeDarkIcon.png", style: "margin: -4px 8px 0 0") %>Install Chrome Extension</a>
      <% else %>
      <!-- for testserver and staging downloads of the Chrome Extension -->
      <iframe id="ce-download" name="ce-download" height=0 width=0 border=0 style="display:none;"></iframe>
      <a id="chrome-extension-button" target="ce-download" class="btn" href="<%= FactlinkUI::Application.config.static_url %>/chrome/factlink-latest.crx"><%= image_tag("chromeDarkIcon.png", style: "margin: -4px 8px 0 0") %>Install Chrome Extension</a>
      <% end %>

    </span>

    <p id="what-is-chrome-extension" class="support-text">What is a Chrome Extension?</p>
  </div>

  <!-- Non-fancy browsers :-) -->
  <div class="hidden button-wrapper no-chrome">
    <p>You can use Factlink with this browser by using the bookmarklet, but keep in mind that this won't give you the full Factlink experience.</p>

    <span class="dashed-border">
      <a id="bookmarklet-button" class="bookmarklet btn" onclick="return false"
           <%# here we need singlequotes kthxbye: %>
           href='javascript:<%= minify_js(ensure_no_single_quotes(render(:partial => 'home/bookmarklet', :formats => [:js]))) %>'><i class='icon-bookmark'></i><span style="display: none">Factlink</span></a>
    </span>
    <p class="support-text">You can drag this Bookmarklet to your bookmarks bar.</p>
  </div>

  <div class="bottom">
    <a id="skip-step" href="<%= create_your_first_factlink_path(ref: 'extension_skip') %>">Skip this step</a>
    <a id="next-step" href="<%= create_your_first_factlink_path(ref: 'extension_next') %>" class="next btn btn-primary btn-large">Next step</a>
  </div>
</div>

<% content_for :javascript do %>
  <script>
    $('#what-is-chrome-extension').popover({placement: 'bottom', title: 'Chrome Extension',
      content: 'Chrome Extensions are applications that run inside the Chrome browser and provide additional functionality. <br><br>The Factlink Chrome Extension will enable you to use Factlink on virtually all websites you visit.'
    })
  </script>

  <script>
    $(function() {

      var notClicked = true;

      $('#chrome-extension-button, #bookmarklet-button').mousedown(function() {
        setTimeout(function (){
          if (notClicked) {
            $('#skip-step').fadeOut(600, function() {
              $('#next-step').fadeIn(600);
            });
            notClicked = false;
          }
        }, 1800);
      });

      <% if Rails.env == "production" %>

        $('#chrome-extension-webstore-button').bind('click', function() {
          mp_track("Extension: Download Chrome Extension -> Clicked #almost-ready");
          chrome.webstore.install(undefined, successFn, errorFn);
        });

        function successFn() {
          mp_track("Extension: Download Chrome Extension -> Successful install #almost-ready");

          $('#skip-step').fadeOut(600, function() {
            window.location = "<%= create_your_first_factlink_path(ref: 'extension_next') %>";
          });
        }
        function errorFn(e) {
          mp_track("Extension: Download Chrome Extension -> Failed install #almost-ready");
          FactlinkApp.NotificationCenter.error("Something went wrong installing the Factlink extension: " + e + ". Please try again.");
        }
      <% end %>

      $('#bookmarklet-button').mousedown(function() {
        mp_track("Bookmarklet: Clicked the Bookmarklet #almost-ready");
      });
    });
  </script>
 <% end %>
