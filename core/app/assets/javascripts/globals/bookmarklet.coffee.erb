#= require './globals'

<%
  bookmarklet_url = FactlinkUI::Application.config.jslib_url +
                    '/factlink_loader' +
                    if 'development' == Rails.env
                      '.js'
                    else
                      '.min.js';
                    end +
                    '?o=bookmarklet'

  bookmarklet = '
    (function(){
      var script = document.createElement("script");
      script.src = "' + bookmarklet_url + '";
      script.onload = function(){ __internalFactlinkState("bookmarkletLoaded"); };
      document.head.appendChild(script);
    })();'

  def minify_js(s)
    res = s
    res = res.gsub(/^\s*\/\/[^\n]*\n/, '')
    res = res.gsub(/\s+/, ' ')
    res
  end

  javascript_helper = Class.new.extend(ActionView::Helpers::JavaScriptHelper)

  escaped_bookmarklet = javascript_helper.escape_javascript(minify_js(bookmarklet))
%>

Factlink.Global.bookmarklet_link = 'javascript:<%= escaped_bookmarklet %>'
