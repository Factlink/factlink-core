#= require './globals'

<%
  bookmarklet_url = FactlinkUI::Application.config.jslib_url +
                    '/factlink_loader' +
                    if 'development' == Rails.env
                      '.js'
                    else
                      '.min.js';
                    end +
                    '?o=bookmarklet'

  def minify_js(s)
    res = s
    res = res.gsub(/^\s*\/\/[^\n]*\n/, '')
    res = res.gsub(/\s+/, ' ')
    res.html_safe
  end

  bookmarklet = minify_js '
    (function(){
      var script = document.createElement("script");
      script.src = "' + bookmarklet_url + '";
      script.onload = function(){ __internalFactlinkState("bookmarkletLoaded"); };
      document.head.appendChild(script);
    })();'

  fail "Please do not use single quotes here" if bookmarklet.match(/'/)
%>

Factlink.Global.bookmarklet_link = 'javascript:<%= bookmarklet %>'
