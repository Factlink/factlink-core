#!/bin/bash
eval "$(rbenv init -)"

#abort this script on any error:
set -e

cd "$( dirname "${BASH_SOURCE[0]}" )"/..

PROXY_BRANCH=''

if [[ ! -e proxy ]]; then
  git clone git://github.com/Factlink/web-proxy.git proxy &
else
  pushd proxy
    PROXY_BRANCH=`git symbolic-ref HEAD 2>/dev/null`
    git pull --ff-only &
  popd
fi

pushd proxy
  git remote set-url proxy-production dokku@188.226.211.29:proxy-production
  git remote set-url proxy-staging dokku@188.226.211.29:proxy-staging
popd

RUBY_VERSION=`cat core/.ruby-version`

echo "Checking for ruby ${RUBY_VERSION}"

rbenv rehash || :
if bash -c "rbenv global ${RUBY_VERSION}" ; then
  #NOTE: we need to run the rbenv global TEST in a separate bash instance
  #because rbenv installs a bash function and due to set -e interaction in can fail.
  echo "Ruby ${RUBY_VERSION} already installed."
else
    echo "Installing ruby ${RUBY_VERSION}..."
    rbenv install ${RUBY_VERSION}
    rbenv rehash || :
fi

if ! type grunt 2>&1 >/dev/null; then
  #/usr/local/share/npm/bin isn't yet in path
  export PATH=$PATH:/usr/local/share/npm/bin
  if ! type grunt 2>&1 >/dev/null; then
    echo "ERROR: Cannot find grunt in path nor in /usr/local/share/npm/bin; exiting."
    exit 1
  fi
  echo 'export PATH=$PATH:/usr/local/share/npm/bin' >> ~/.bash_profile
fi

rbenv shell "${RUBY_VERSION}"

type git-up 2>/dev/null || gem install git-up
type bundler 2>/dev/null || gem install bundler
rbenv rehash || :
rbenv shell --unset



cd local_development
  shasum --check Gemfile.lock.sha-cache || (
    bundle -j4
    shasum Gemfile.lock > Gemfile.lock.sha-cache
  )
cd ..

cd testserver
  shasum --check Gemfile.lock.sha-cache || (
    bundle -j4
    shasum Gemfile.lock > Gemfile.lock.sha-cache
  )
cd ..

js-library/bin/bootstrap
core/bin/bootstrap $1


wait
proxy/bin/bootstrap


if [ "$PROXY_BRANCH" != "refs/heads/master" ]; then
  echo -e "\n\n"
  for i in {1..5}
  do
    echo 'WARNING: Your proxy subrepo is NOT at the master branch!'
  done
else
  echo "Your factlink development environment is done.  Happy hacking!"
fi

